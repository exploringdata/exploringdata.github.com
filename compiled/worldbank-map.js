async function M(e,n){let t=B(n);D(e,$(t.colorScheme)),t.ocean&&e.style.setProperty("--wbm-ocean",t.ocean);let a=R(e,t);h(a.status,"loading");let o,r;try{[o,r]=await Promise.all([fetch(t.topoUrl).then(f=>f.json()),I(t.indicator)])}catch(f){console.error("[worldbank-map]",f),h(a.status,"error"),a.placeholder.textContent="Failed to load data \u2014 see console for details.";return}let{dataByYearCountry:l,colorDomain:c,years:i}=O(r,t);z(a.yearSelect,i,t.initialYear),h(a.status,"ready"),a.placeholder.remove(),t.animationInterval>0&&(a.playBtn.disabled=!1),L(a.legend,c,t);let{draw:u,resetZoom:m}=A(o,l,c,a.canvas,t);u(a.yearSelect.value),F(a,i,u,m,t)}function B(e){return{indicator:e.indicator,topoUrl:e.topoUrl,topoObject:e.topoObject,title:e.title??e.indicator,emoji:e.emoji??"",unit:e.unit??"",colorScheme:e.colorScheme??"Blues",colorReverse:e.colorReverse??!1,initialYear:e.initialYear??null,animationInterval:e.animationInterval??800,colorDomain:e.colorDomain??null,ocean:e.ocean??null,clampPercentile:e.clampPercentile??1}}var E={loading:"#d29922",error:"#f85149"},S={Greens:{bg:"#0d1117",surface:"#161b22",border:"#30363d",text:"#e6edf3",muted:"#8b949e",accent:"#3fb950",accentDim:"#1a3d25",ocean:"#0d2233",graticule:"#1c2333"},Blues:{bg:"#0d1117",surface:"#161b22",border:"#30363d",text:"#e6edf3",muted:"#8b949e",accent:"#58a6ff",accentDim:"#1a2d4a",ocean:"#0a1628",graticule:"#1c2333"},Oranges:{bg:"#110c07",surface:"#1c1208",border:"#3d2a14",text:"#f0e6d3",muted:"#a08060",accent:"#f0883e",accentDim:"#3d200a",ocean:"#1a1000",graticule:"#2a1e0e"},Purples:{bg:"#0d0a17",surface:"#16122a",border:"#30246d",text:"#e6e0f3",muted:"#8878ae",accent:"#bc8cff",accentDim:"#2d1a4a",ocean:"#110d1e",graticule:"#1e1833"},Reds:{bg:"#110808",surface:"#1c1010",border:"#4a2020",text:"#f3e0e0",muted:"#a07070",accent:"#ff7b72",accentDim:"#4a1a1a",ocean:"#1a0a0a",graticule:"#2e1818"},YlOrRd:{bg:"#110d00",surface:"#1c1600",border:"#3d2e00",text:"#f3ead0",muted:"#a09060",accent:"#ffa657",accentDim:"#3d2500",ocean:"#1a1200",graticule:"#2a2200"}};function $(e){return{...E,...S[e]??S.Blues}}function D(e,n){let t=a=>a.replace(/[A-Z]/g,o=>`-${o.toLowerCase()}`);Object.entries(n).forEach(([a,o])=>{e.style.setProperty(`--wbm-${t(a)}`,o)})}function R(e,n){e.classList.add("wbm");let t=d("header","wbm-header"),a=d("div");a.append(d("h1","wbm-title",[n.emoji,n.title].filter(Boolean).join(" ")),d("p","wbm-subtitle",`${n.indicator} \xB7 ${n.unit}`));let o=d("button","wbm-play-btn","\u25B6");o.disabled=!0,o.title="Play animation",n.animationInterval===0&&o.classList.add("hidden");let r=d("select","wbm-select"),l=d("span","wbm-status","loading\u2026"),c=d("div","wbm-controls");c.append(o,d("label","wbm-label","YEAR"),r,l);let i=d("div","wbm-legend");t.append(a,c,i);let u=d("div","wbm-canvas"),m=d("div","wbm-placeholder","Fetching data\u2026");return u.appendChild(m),e.append(t,u),{playBtn:o,yearSelect:r,status:l,legend:i,canvas:u,placeholder:m}}function d(e,n,t){let a=document.createElement(e);return n&&(a.className=n),t&&(a.textContent=t),a}function h(e,n){let t={loading:"loading\u2026",ready:"ready",error:"error"};e.dataset.state=n,e.textContent=t[n]}async function I(e){let n=`https://api.worldbank.org/v2/country/all/indicator/${e}`,t=l=>`${n}?${new URLSearchParams({format:"json",per_page:1e3,page:l})}`,[a,o]=await fetch(t(1)).then(l=>l.json()),r=await Promise.all(Array.from({length:a.pages-1},(l,c)=>fetch(t(c+2)).then(i=>i.json()).then(([,i])=>i)));return[...o,...r.flat()].filter(l=>l.value!==null&&l.countryiso3code)}function O(e,n){let t=d3.rollup(e,r=>r[0].value,r=>r.date,r=>r.countryiso3code),a=[...t.keys()].sort((r,l)=>l-r),o=n.colorDomain??q(e,n.clampPercentile);return{dataByYearCountry:t,colorDomain:o,years:a}}function q(e,n){let t=e.map(r=>r.value).sort(d3.ascending),a=d3.quantile(t,n/100),o=d3.quantile(t,1-n/100);return[a,o]}function z(e,n,t){n.forEach(a=>{let o=d("option",null,a);o.value=a,e.appendChild(o)}),e.value=t&&n.includes(String(t))?String(t):n[0]}function A(e,n,t,a,o){let r=topojson.feature(e,e.objects[o.topoObject]),l=getComputedStyle(a),c=p=>l.getPropertyValue(`--wbm-${p}`).trim(),i=c("ocean"),u=c("graticule"),m=c("bg"),f={type:"sequential",scheme:o.colorScheme,reverse:o.colorReverse,domain:t,unknown:"#999999"},b=d3.zoom().scaleExtent([1,12]).on("zoom",({transform:p})=>{let y=a.querySelector("svg");y&&d3.select(y).selectAll(":scope > g").attr("transform",p)});function P(){let p=a.querySelector("svg");p&&d3.select(p).call(b.transform,d3.zoomIdentity)}function k(p){d3.select(p).call(b).on("dblclick.zoom",null)}function x(p){let y=n.get(p)??new Map,g=s=>s.id?y.get(s.id)??null:null,v=Plot.plot({width:a.clientWidth,height:a.clientHeight,projection:{type:"equal-earth",domain:{type:"Sphere"}},color:f,style:{background:"transparent",overflow:"visible"},marks:[Plot.sphere({fill:i}),Plot.graticule({stroke:u,strokeOpacity:.5,strokeWidth:.4}),Plot.geo(r,{fill:s=>g(s),stroke:m,strokeWidth:.4,title:s=>{let C=s.id??"Unknown",w=g(s),j=w!==null?`${w.toFixed(1)}${o.unit?"  "+o.unit:""}`:"no data";return`${C}  ${j}`},tip:!0}),Plot.text([o.indicator],{frameAnchor:"bottom",text:s=>`data.worldbank.org/indicator/${s}`,href:s=>`https://data.worldbank.org/indicator/${s}`,target:"_blank",fill:c("muted"),fontSize:11,fontFamily:l.getPropertyValue("--wbm-mono").trim(),dy:-8})]});a.querySelectorAll("svg").forEach(s=>s.remove()),a.appendChild(v),k(v)}return{draw:x,resetZoom:P}}function L(e,n,t){let a=getComputedStyle(e);e.appendChild(Plot.legend({color:{type:"sequential",scheme:t.colorScheme,reverse:t.colorReverse,domain:n,label:t.unit,ticks:5},style:{background:"transparent",color:a.getPropertyValue("--wbm-text").trim(),fontFamily:a.getPropertyValue("--wbm-mono").trim(),fontSize:"11px"}}))}function F(e,n,t,a,o){let r=[...n].reverse(),l=null;function c(){let m=r[(r.indexOf(e.yearSelect.value)+1)%r.length];e.yearSelect.value=m,t(m)}function i(){l=setInterval(c,o.animationInterval),e.playBtn.textContent="\u23F8",e.playBtn.title="Pause animation"}function u(){clearInterval(l),l=null,e.playBtn.textContent="\u25B6",e.playBtn.title="Play animation"}e.playBtn.addEventListener("click",()=>l?u():i()),e.yearSelect.addEventListener("change",()=>t(e.yearSelect.value)),e.yearSelect.addEventListener("mousedown",()=>{l&&u()}),new ResizeObserver(([m])=>{let{width:f,height:b}=m.contentRect;f>0&&b>0&&(a(),t(e.yearSelect.value))}).observe(e.canvas)}export{M as createMap};
