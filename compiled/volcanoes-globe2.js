let index=0;let intervalId=null;const eltInfo=document.getElementById('info');eltInfo.style.visibility='hidden';const catColor=d3.scaleOrdinal(d3.schemeCategory10);const getAlt=d=>d.elevation*6e-5;const synth=window.speechSynthesis;const ANIMATION_CYCLE=4000;const ANIMATION_TIME=2000;const ALTITUDE=0.75;const getTooltip=d=>`<div>
        <strong>${d.name}</strong><br>
        Elevation: ${d.elevation}m<br>
        Location: ${d.country}<br>
        Type: ${d.type}
    </div>
`;const G=Globe().globeImageUrl('/img/public/earth-topology.png').backgroundImageUrl('/img/public/night-sky.png').pointLat('lat').pointLng('lon').pointAltitude(getAlt).pointRadius(.12).pointColor(d=>catColor(d.type)).pointLabel(getTooltip)(document.getElementById('vis'));let isRecording=false;let recorder=null;let audioContext=null;let mediaStreamDestination=null;function setupRecording(){audioContext=new(window.AudioContext||window.webkitAudioContext);mediaStreamDestination=audioContext.createMediaStreamDestination();const canvas=document.querySelector('#vis canvas');const videoStream=canvas.captureStream(30);const combinedStream=new MediaStream([...videoStream.getVideoTracks(),...mediaStreamDestination.stream.getAudioTracks()]);recorder=new MediaRecorder(combinedStream,{mimeType:'video/webm'});recorder.ondataavailable=e=>{if(e.data.size>0){const blob=new Blob([e.data],{type:'video/webm'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='webgl-animation.webm';a.click();URL.revokeObjectURL(url)}}}function startRecording(){if(!isRecording){setupRecording();recorder.start();isRecording=true;console.log('Recording started')}}function stopRecording(){if(isRecording){recorder.stop();isRecording=false;console.log('Recording stopped');if(audioContext){audioContext.close();audioContext=null}}}function speakText(text){return new Promise(resolve=>{const utterance=new SpeechSynthesisUtterance(text);utterance.onend=resolve;synth.speak(utterance);if(audioContext&&mediaStreamDestination){const source=audioContext.createMediaStreamSource(new MediaStream([synth.getVoices()[0].audioStream]));source.connect(mediaStreamDestination)}})}function animation(){if(intervalId){stopRecording();clearInterval(intervalId);intervalId=null;eltInfo.style.visibility='hidden'}else{startRecording();setPoint();intervalId=setInterval(setPoint,ANIMATION_CYCLE)}}function setPoint(){const data=G.pointsData();G.pointOfView({lat:data[index].lat,lng:data[index].lon,altitude:ALTITUDE},ANIMATION_TIME);eltInfo.innerHTML=getTooltip(data[index]);eltInfo.style.visibility='visible';const text=`${data[index].name} ${data[index].country}`;speakText(text);index=(index+1)%data.length}setupRecording();fetch('/csv/volcanoes.csv').then(res=>res.text()).then(csv=>d3.csvParse(csv,d=>{return{name:d['Volcano Name'],country:d['Country'],type:d['Type'],lat:d['Latitude (dd)'],lon:d['Longitude (dd)'],elevation:d['Elevation (m)']}})).then(data=>G.pointsData(data));document.getElementById('play-pause').addEventListener('click',animation);document.addEventListener('keydown',event=>{if(event.key==='p'){animation()}});