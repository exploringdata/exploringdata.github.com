const{Deck}=deck;const{ScatterplotLayer}=deck;const{TerrainLayer}=deck;const{CSVLoader}=loaders;const MAX_ZOOM=15;const RADIUS=20;const CURRENT_PHOTO_RADIUS=40;const INITIAL_VIEW_STATE={latitude:36.77,longitude:-3.88,zoom:13.5,bearing:180,pitch:40,maxPitch:80};const TERRARIUM_ELEVATION='https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png';const TERRARIUM_DECODER={rScaler:256,gScaler:1,bScaler:1/256,offset:-32768};const ESRI_SATELLITE='https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';const terrain=new TerrainLayer({id:'terrain',minZoom:0,maxZoom:MAX_ZOOM,strategy:'no-overlap',elevationDecoder:TERRARIUM_DECODER,elevationData:TERRARIUM_ELEVATION,texture:ESRI_SATELLITE,wireframe:false,color:[255,255,255]});const BTN_PLAY=document.getElementById('play-btn');const BTN_PREV=document.getElementById('prev-btn');const BTN_NEXT=document.getElementById('next-btn');const BTN_FIRST=document.getElementById('first-btn');const BTN_LAST=document.getElementById('last-btn');const BTN_INFO=document.getElementById('info-btn');const MODAL=document.getElementById('info-modal');const MODAL_CLOSE=document.querySelector('.modal-close');let allPhotos=[];let currentPhotoIndex=0;let isPlaying=false;let playInterval=null;async function loadPhotos(){const response=await fetch('/csv/nerja-dataset-gps.csv');const csvText=await response.text();const lines=csvText.trim().split('\n');allPhotos=lines.slice(1).map(line=>{const values=line.split(',');return{filestem:values[0],latitude:parseFloat(values[1]),longitude:parseFloat(values[2]),altitude:parseFloat(values[3]),timestamp:values[4]}});allPhotos.sort((a,b)=>a.timestamp.localeCompare(b.timestamp));document.getElementById('total-photos').textContent=allPhotos.length;updateDisplay()}function createPhotoLayers(){const visitedPhotos=allPhotos.slice(0,currentPhotoIndex);const currentPhoto=allPhotos[currentPhotoIndex];const layers=[terrain];if(visitedPhotos.length>0){layers.push(new ScatterplotLayer({id:'visited-photos',data:visitedPhotos,getPosition:d=>[d.longitude,d.latitude,d.altitude],getFillColor:[150,150,150,150],getRadius:RADIUS,pickable:false}))}if(currentPhoto){layers.push(new ScatterplotLayer({id:'current-photo',data:[currentPhoto],getPosition:d=>[d.longitude,d.latitude,d.altitude],getFillColor:[255,140,0,255],getRadius:CURRENT_PHOTO_RADIUS,pickable:true}))}return layers}function updateDisplay(){if(allPhotos.length===0)return;const currentPhoto=allPhotos[currentPhotoIndex];document.getElementById('current-photo').textContent=currentPhotoIndex+1;const timestamp=currentPhoto.timestamp;const datePart=timestamp.substring(0,10).replace(/:/g,'-');const timePart=timestamp.substring(11,16);const date=new Date(datePart);const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];const month=months[date.getMonth()];const day=date.getDate();document.getElementById('timestamp').textContent=`${month} ${day} ${timePart}`;const photoElement=document.getElementById('photo');photoElement.setAttribute('src',`/img/nerja-dataset/${currentPhoto.filestem}.webp`);const progress=(currentPhotoIndex+1)/allPhotos.length*100;document.getElementById('progress-bar').style.width=progress+'%';deckInstance.setProps({layers:createPhotoLayers()});deckInstance.setProps({initialViewState:{longitude:currentPhoto.longitude,latitude:currentPhoto.latitude,zoom:15,bearing:180,pitch:40,transitionDuration:2000,transitionInterpolator:new deck.FlyToInterpolator}})}function highlightAll(){deckInstance.setProps({layers:[terrain,new ScatterplotLayer({id:'all-photos-highlighted',data:allPhotos,getPosition:d=>[d.longitude,d.latitude,d.altitude],getFillColor:[255,140,0,255],getRadius:RADIUS,pickable:true})]})}function nextPhoto(){if(currentPhotoIndex<allPhotos.length-1){currentPhotoIndex++;updateDisplay()}else{end()}}function previousPhoto(){if(currentPhotoIndex>0){currentPhotoIndex--;updateDisplay()}}function firstPhoto(){if(currentPhotoIndex!==0){currentPhotoIndex=0;updateDisplay()}}function lastPhoto(){if(currentPhotoIndex!==allPhotos.length-1){currentPhotoIndex=allPhotos.length-1;updateDisplay()}}function play(){if(currentPhotoIndex>=allPhotos.length-1){currentPhotoIndex=0;updateDisplay()}isPlaying=true;BTN_PLAY.textContent='\u23F8';playInterval=setInterval(nextPhoto,3000)}function pause(){isPlaying=false;BTN_PLAY.textContent='\u25B6';if(playInterval){clearInterval(playInterval);playInterval=null}}function togglePlay(){if(isPlaying){pause()}else{play()}}function end(){pause();highlightAll()}let deckInstance=new Deck({canvas:document.getElementById('deck'),initialViewState:INITIAL_VIEW_STATE,controller:true,layers:[terrain]});BTN_FIRST.addEventListener('click',firstPhoto);BTN_PREV.addEventListener('click',previousPhoto);BTN_PLAY.addEventListener('click',togglePlay);BTN_NEXT.addEventListener('click',nextPhoto);BTN_LAST.addEventListener('click',lastPhoto);BTN_INFO.addEventListener('click',()=>{MODAL.style.display='block'});MODAL_CLOSE.addEventListener('click',()=>{MODAL.style.display='none'});window.addEventListener('click',e=>{if(e.target===MODAL){MODAL.style.display='none'}});document.addEventListener('keydown',e=>{switch(e.key){case'ArrowLeft':previousPhoto();break;case'ArrowRight':nextPhoto();break;case'Home':firstPhoto();break;case'End':lastPhoto();break;case' ':case'Spacebar':e.preventDefault();togglePlay();break;}});loadPhotos().then(()=>{document.getElementById('loading').style.display='none';document.getElementById('controls').style.display='flex'});